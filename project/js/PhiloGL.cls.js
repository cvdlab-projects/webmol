/*

 Copyright (c) 2011 Sencha Labs - Author: Nicolas Garcia Belmonte (http://philogb.github.com/)

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated documentation files (the "Software"), to deal
 in the Software without restriction, including without limitation the rights
 to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the Software is
 furnished to do so, subject to the following conditions:

 The above copyright notice and this permission notice shall be included in
 all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 THE SOFTWARE.

*/
(function(){function u(y){return document.getElementById(y)}this.PhiloGL=null;(function(){PhiloGL=function(y,z){function s(q,w,t){var A=q.canvas,a=new PhiloGL.Camera(j.fov,A.width/A.height,j.near,j.far,j);a.update();var b=new PhiloGL.Scene(w,a,c);M=new PhiloGL.WebGL.Application({gl:q,canvas:A,program:w,scene:b,camera:a});w.$$family=="program"&&w.use();f&&PhiloGL.Events.create(M,u.extend(f,{bind:M}));if(d.src.length)new PhiloGL.IO.Textures(u.extend(d,{onComplete:function(){t(M)}}));else t(M)}z=u.merge({context:{},
camera:{fov:45,near:0.1,far:500},program:{from:"defaults",vs:"Default",fs:"Default"},scene:{},textures:{src:[]},events:{},onLoad:u.empty,onError:u.empty},z||{});var k=z.context,j=z.camera,f=z.events,d=z.textures,i=u.splat(z.program),c=z.scene;o=PhiloGL.WebGL.getContext(y,k);if(!o){z.onError("The WebGL context couldn't been initialized");return null}var h={defaults:"fromDefaultShaders",ids:"fromShaderIds",sources:"fromShaderSources",uris:"fromShaderURIs"},l=i.length,m=function(){var q=l,w={},t=false;
return{onSuccess:function(A,a){w[a.id||l-q]=A;q--;if(q===0&&!t)s(o,l==1?A:w,function(b){z.onLoad(b)})},onError:function(A){q--;z.onError(A);t=true}}}();i.forEach(function(q){var w=q.from,t,A;for(A in h)if(w==A){try{t=PhiloGL.Program[h[A]](u.extend(m,q))}catch(a){m.onError(a)}break}if(t)m.onSuccess(t,q)})}})();PhiloGL.unpack=function(y){y=y||aa;["Vec3","Mat4","Quat","Camera","Program","WebGL","O3D","Scene","Shaders","IO","Events","WorkerGroup","Fx","Media"].forEach(function(z){y[z]=PhiloGL[z]});y.gl=
o;y.Utils=u};PhiloGL.version="1.5.0";var o,M,aa=this;u.empty=function(){};u.time=Date.now;u.uid=function(){var y=u.time();return function(){return y++}}();u.extend=function(y,z){for(var s in z)y[s]=z[s];return y};u.type=function(){var y=Object.prototype.toString;return function(z){var s;s=y.call(z);s=s.substr(8,s.length-9).toLowerCase();if(s!="object")return s;if(z.$$family)return z.$$family;return z&&z.nodeName&&z.nodeType==1?"element":s}}();(function(){function y(z){var s=u.type(z);if(s=="object"){s=
{};for(var k in z)s[k]=y(z[k]);return s}else if(s=="array"){s=[];k=0;for(var j=z.length;k<j;k++)s[k]=y(z[k]);return s}else return z}u.merge=function(){for(var z={},s=0,k=arguments.length;s<k;s++){var j=arguments[s];if(u.type(j)=="object")for(var f in j){var d=j[f],i=z[f];z[f]=i&&u.type(d)=="object"&&u.type(i)=="object"?u.merge(i,d):y(d)}}return z}})();u.splat=function(){var y=Array.isArray;return function(z){return y(z)&&z||[z]}}();(function(){function y(s){for(var k in s)this[k]=s[k];this.buffers=
{};this.bufferMemo={};this.frameBuffers={};this.frameBufferMemo={};this.renderBuffers={};this.renderBufferMemo={};this.textures={};this.textureMemo={}}var z={getContext:function(s,k){s=typeof s=="string"?u(s):s;var j;(j=s.getContext("experimental-webgl",k))||(j=s.getContext("webgl",k));if(j&&k&&k.debug){o={};for(var f in j){var d=j[f];o[f]=typeof d=="function"?function(i,c){return function(){console.log(i,Array.prototype.join.call(arguments),Array.prototype.slice.call(arguments));try{var h=c.apply(j,
arguments)}catch(l){throw i+" "+l;}for(var m=[],q;(q=j.getError())!==j.NO_ERROR;)m.push(q);if(m.length)throw m.join();return h}}(f,d):d}}else o=j;if(o)o.get=function(i){return typeof i=="string"?o[i]:i};return o}};y.prototype={$$family:"application",setBuffer:function(s,k,j){if(j===false||j===null){(j=this.bufferMemo[k])&&o.bindBuffer(j.bufferType,null);var f=j&&j.attribute||k;s=s.attributes[f];s!==undefined&&o.disableVertexAttribArray(s)}else{j=u.extend(this.bufferMemo[k]||{bufferType:o.ARRAY_BUFFER,
size:1,dataType:o.FLOAT,stride:0,offset:0,drawType:o.STATIC_DRAW},j||{});f=j.attribute||k;var d=j.bufferType,i=k in this.buffers,c=i?this.buffers[k]:o.createBuffer(),h="value"in j,l=j.value,m=j.size,q=j.dataType,w=j.stride,t=j.offset,A=j.drawType;s=s.attributes[f];var a=s!==undefined;i||(this.buffers[k]=c);a&&o.enableVertexAttribArray(s);o.bindBuffer(d,c);h&&o.bufferData(d,l,A);a&&o.vertexAttribPointer(s,m,q,false,w,t);delete j.value;this.bufferMemo[k]=j;if(a)this.bufferMemo[f]=j;return this}},setBuffers:function(s,
k){for(var j in k)this.setBuffer(s,j,k[j]);return this},setFrameBuffer:function(s,k){if(typeof k!="object")o.bindFramebuffer(o.FRAMEBUFFER,k?this.frameBuffers[s]:null);else{k=u.merge(this.frameBufferMemo[s]||{width:0,height:0,bindToTexture:false,textureOptions:{attachment:o.COLOR_ATTACHMENT0},bindToRenderBuffer:false,renderBufferOptions:{attachment:o.DEPTH_ATTACHMENT}},k||{});var j=k.bindToTexture,f=k.bindToRenderBuffer,d=s in this.frameBuffers,i=d?this.frameBuffers[s]:o.createFramebuffer();o.bindFramebuffer(o.FRAMEBUFFER,
i);d||(this.frameBuffers[s]=i);if(j){j=u.merge({data:{width:k.width,height:k.height}},u.type(j)=="object"?j:{});d=s+"-texture";i=k.textureOptions;this.setTexture(d,j);o.framebufferTexture2D(o.FRAMEBUFFER,i.attachment,this.textureMemo[d].textureType,this.textures[d],0)}if(f){f=u.extend({width:k.width,height:k.height},u.type(f)=="object"?f:{});j=s+"-renderbuffer";d=k.renderBufferOptions;this.setRenderBuffer(j,f);o.framebufferRenderbuffer(o.FRAMEBUFFER,d.attachment,o.RENDERBUFFER,this.renderBuffers[j])}o.bindTexture(o.TEXTURE_2D,
null);o.bindRenderbuffer(o.RENDERBUFFER,null);o.bindFramebuffer(o.FRAMEBUFFER,null);this.frameBufferMemo[s]=k;return this}},setFrameBuffers:function(s){for(var k in s)this.setFrameBuffer(k,s[k]);return this},setRenderBuffer:function(s,k){if(typeof k!="object")o.bindRenderbuffer(o.RENDERBUFFER,k?this.renderBufferMemo[s]:null);else{k=u.extend(this.renderBufferMemo[s]||{storageType:o.DEPTH_COMPONENT16,width:0,height:0},k||{});var j=s in this.renderBuffers,f=j?this.renderBuffers[s]:o.createRenderbuffer(o.RENDERBUFFER);
j||(this.renderBuffers[s]=f);o.bindRenderbuffer(o.RENDERBUFFER,f);o.renderbufferStorage(o.RENDERBUFFER,k.storageType,k.width,k.height);this.renderBufferMemo[s]=k;return this}},setRenderBuffers:function(s){for(var k in s)this.setRenderBuffer(k,s[k]);return this},setTexture:function(s,k){if(!k||typeof k!="object"){o.activeTexture(k||o.TEXTURE0);o.bindTexture(this.textureMemo[s].textureType||o.TEXTURE_2D,this.textures[s])}else{if(k.data&&k.data.type===o.FLOAT)if(!o.getExtension("OES_texture_float"))throw"OES_texture_float is not supported";
k=u.merge(this.textureMemo[s]||{textureType:o.TEXTURE_2D,pixelStore:[{name:o.UNPACK_FLIP_Y_WEBGL,value:true},{name:o.UNPACK_ALIGNMENT,value:1}],parameters:[{name:o.TEXTURE_MAG_FILTER,value:o.NEAREST},{name:o.TEXTURE_MIN_FILTER,value:o.NEAREST}],data:{format:o.RGBA,value:false,type:o.UNSIGNED_BYTE,width:0,height:0,border:0}},k||{});var j="textureType"in k?k.textureType=o.get(k.textureType):o.TEXTURE_2D,f="textureTarget"in k?k.textureTarget=o.get(k.textureTarget):j,d=j==o.TEXTURE_CUBE_MAP,i=s in this.textures,
c=i?this.textures[s]:o.createTexture(),h=k.pixelStore,l=k.parameters,m=k.data,q=m.value,w=m.type,t=m.format,A=!!m.value;i||(this.textures[s]=c);o.bindTexture(j,c);i||h.forEach(function(a){a.name=typeof a.name=="string"?o.get(a.name):a.name;o.pixelStorei(a.name,a.value)});if(A)if(d)for(c=0;c<6;++c)o.texImage2D(f[c],0,t,t,w,q[c]);else o.texImage2D(f,0,t,t,w,q);else if(m.width||m.height)o.texImage2D(f,0,t,m.width,m.height,m.border,t,w,null);if(!i)for(c=0;c<l.length;c++){f=l[c];f.name=o.get(f.name);f.value=
o.get(f.value);o.texParameteri(j,f.name,f.value);f.generateMipmap&&o.generateMipmap(j)}k.isCube=d;if(A)k.data.value=false;this.textureMemo[s]=k;return this}},setTextures:function(s){for(var k in s)this.setTexture(k,s[k]);return this},use:function(s){o.useProgram(s.program);this.usedProgram=s;return this}};z.Application=y;(function(){try{var s=document.createElement("canvas");PhiloGL.hasWebGL=function(){return!!(window.WebGLRenderingContext&&(s.getContext("webgl")||s.getContext("experimental-webgl")))}}catch(k){PhiloGL.hasWebGL=
function(){return false}}})();PhiloGL.WebGL=z})();(function(){function y(a){return{get:function(){return this[a]},set:function(b){this[a]=b},configurable:false,enumerable:false}}var z=Math.sqrt,s=Math.sin,k=Math.cos,j=Math.tan,f=Math.PI,d=Array.prototype.slice,i=this.Float32Array,c=function(){if(!i||!i.call)return Array;try{i.call({},10)}catch(a){return Array}return i}(),h=c!=Array,l=function(a,b,g){if(h){i.call(this,3);this[0]=a||0;this[1]=b||0;this[2]=g||0}else this.push(a||0,b||0,g||0);this.typedContainer=
new i(3)};l.create=function(){return new i(3)};l.prototype=Object.create(c.prototype,{$$family:{value:"Vec3"},x:y(0),y:y(1),z:y(2)});var m={setVec3:function(a,b){a[0]=b[0];a[1]=b[1];a[2]=b[2];return a},set:function(a,b,g,n){a[0]=b;a[1]=g;a[2]=n;return a},add:function(a,b){return new l(a[0]+b[0],a[1]+b[1],a[2]+b[2])},$add:function(a,b){a[0]+=b[0];a[1]+=b[1];a[2]+=b[2];return a},add2:function(a,b,g){a[0]=b[0]+g[0];a[1]=b[1]+g[1];a[2]=b[2]+g[2];return a},sub:function(a,b){return new l(a[0]-b[0],a[1]-
b[1],a[2]-b[2])},$sub:function(a,b){a[0]-=b[0];a[1]-=b[1];a[2]-=b[2];return a},sub2:function(a,b,g){a[0]=b[0]-g[0];a[1]=b[1]-g[1];a[2]=b[2]-g[2];return a},scale:function(a,b){return new l(a[0]*b,a[1]*b,a[2]*b)},$scale:function(a,b){a[0]*=b;a[1]*=b;a[2]*=b;return a},neg:function(a){return new l(-a[0],-a[1],-a[2])},$neg:function(a){a[0]=-a[0];a[1]=-a[1];a[2]=-a[2];return a},unit:function(a){var b=l.norm(a);if(b>0)return l.scale(a,1/b);return l.clone(a)},$unit:function(a){var b=l.norm(a);if(b>0)return l.$scale(a,
1/b);return a},cross:function(a,b){var g=a[0],n=a[1],p=a[2],r=b[0],v=b[1],x=b[2];return new l(n*x-p*v,p*r-g*x,g*v-n*r)},$cross:function(a,b){var g=a[0],n=a[1],p=a[2],r=b[0],v=b[1],x=b[2];a[0]=n*x-p*v;a[1]=p*r-g*x;a[2]=g*v-n*r;return a},distTo:function(a,b){var g=a[0]-b[0],n=a[1]-b[1],p=a[2]-b[2];return z(g*g+n*n+p*p)},distToSq:function(a,b){var g=a[0]-b[0],n=a[1]-b[1],p=a[2]-b[2];return g*g+n*n+p*p},norm:function(a){var b=a[0],g=a[1];a=a[2];return z(b*b+g*g+a*a)},normSq:function(a){var b=a[0],g=a[1];
a=a[2];return b*b+g*g+a*a},dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},clone:function(a){return a.$$family?new l(a[0],a[1],a[2]):l.setVec3(new i(3),a)},toFloat32Array:function(a){var b=a.typedContainer;if(!b)return a;b[0]=a[0];b[1]=a[1];b[2]=a[2];return b}},q=l.prototype,w;for(w in m){l[w]=m[w];q[w]=function(a){return function(){var b=d.call(arguments);b.unshift(this);return l[a].apply(l,b)}}(w)}var t=function(a,b,g,n,p,r,v,x,B,C,D,E,G,I,J,H){c.call(this,16);this.length=16;typeof a=="number"?
this.set(a,b,g,n,p,r,v,x,B,C,D,E,G,I,J,H):this.id();this.typedContainer=new i(16)};t.create=function(){return new i(16)};t.prototype=Object.create(c.prototype,{$$family:{value:"Mat4"},n11:y(0),n12:y(4),n13:y(8),n14:y(12),n21:y(1),n22:y(5),n23:y(9),n24:y(13),n31:y(2),n32:y(6),n33:y(10),n34:y(14),n41:y(3),n42:y(7),n43:y(11),n44:y(15)});m={id:function(a){a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return a},clone:function(a){return a.$$family?
new t(a[0],a[4],a[8],a[12],a[1],a[5],a[9],a[13],a[2],a[6],a[10],a[14],a[3],a[7],a[11],a[15]):new i(a)},set:function(a,b,g,n,p,r,v,x,B,C,D,E,G,I,J,H,F){a[0]=b;a[4]=g;a[8]=n;a[12]=p;a[1]=r;a[5]=v;a[9]=x;a[13]=B;a[2]=C;a[6]=D;a[10]=E;a[14]=G;a[3]=I;a[7]=J;a[11]=H;a[15]=F;return a},mulVec3:function(a,b){var g=l.clone(b);return t.$mulVec3(a,g)},$mulVec3:function(a,b){var g=b[0],n=b[1],p=b[2],r=1/(a[3]*g+a[7]*n+a[11]*p+a[15]);b[0]=(a[0]*g+a[4]*n+a[8]*p+a[12])*r;b[1]=(a[1]*g+a[5]*n+a[9]*p+a[13])*r;b[2]=
(a[2]*g+a[6]*n+a[10]*p+a[14])*r;return b},mulMat42:function(a,b,g){var n=b[0],p=b[1],r=b[2],v=b[3],x=b[4],B=b[5],C=b[6],D=b[7],E=b[8],G=b[9],I=b[10],J=b[11],H=b[12],F=b[13],N=b[14];b=b[15];var K=g[0],L=g[1],P=g[2],Q=g[3],R=g[4],U=g[5],V=g[6],W=g[7],S=g[8],T=g[9],X=g[10],O=g[11],Y=g[12],Z=g[13],$=g[14];g=g[15];a[0]=K*n+L*x+P*E+Q*H;a[1]=K*p+L*B+P*G+Q*F;a[2]=K*r+L*C+P*I+Q*N;a[3]=K*v+L*D+P*J+Q*b;a[4]=R*n+U*x+V*E+W*H;a[5]=R*p+U*B+V*G+W*F;a[6]=R*r+U*C+V*I+W*N;a[7]=R*v+U*D+V*J+W*b;a[8]=S*n+T*x+X*E+O*H;a[9]=
S*p+T*B+X*G+O*F;a[10]=S*r+T*C+X*I+O*N;a[11]=S*v+T*D+X*J+O*b;a[12]=Y*n+Z*x+$*E+g*H;a[13]=Y*p+Z*B+$*G+g*F;a[14]=Y*r+Z*C+$*I+g*N;a[15]=Y*v+Z*D+$*J+g*b;return a},mulMat4:function(a,b){var g=t.clone(a);return t.mulMat42(g,a,b)},$mulMat4:function(a,b){return t.mulMat42(a,a,b)},add:function(a,b){var g=t.clone(a);return t.$add(g,b)},$add:function(a,b){a[0]+=b[0];a[1]+=b[1];a[2]+=b[2];a[3]+=b[3];a[4]+=b[4];a[5]+=b[5];a[6]+=b[6];a[7]+=b[7];a[8]+=b[8];a[9]+=b[9];a[10]+=b[10];a[11]+=b[11];a[12]+=b[12];a[13]+=
b[13];a[14]+=b[14];a[15]+=b[15];return a},transpose:function(a){a=t.clone(a);return t.$transpose(a)},$transpose:function(a){var b=a[8],g=a[12],n=a[1],p=a[9],r=a[13],v=a[2],x=a[6],B=a[14],C=a[3],D=a[7],E=a[11];a[1]=a[4];a[2]=b;a[3]=g;a[4]=n;a[6]=p;a[7]=r;a[8]=v;a[9]=x;a[11]=B;a[12]=C;a[13]=D;a[14]=E;return a},rotateAxis:function(a,b,g){a=t.clone(a);return t.$rotateAxis(a,b,g)},$rotateAxis:function(a,b,g){var n=s(b),p=k(b),r=1-p,v=g[0],x=g[1],B=g[2];g=v*v*r+p;b=v*x*r+B*n;var C=v*B*r-x*n,D=x*v*r-B*n,
E=x*x*r+p,G=x*B*r+v*n,I=v*B*r+x*n;n=x*B*r-v*n;p=B*B*r+p;r=a[0];v=a[1];x=a[2];B=a[3];var J=a[4],H=a[5],F=a[6],N=a[7],K=a[8],L=a[9],P=a[10],Q=a[11];a[0]=r*g+J*b+K*C;a[1]=v*g+H*b+L*C;a[2]=x*g+F*b+P*C;a[3]=B*g+N*b+Q*C;a[4]=r*D+J*E+K*G;a[5]=v*D+H*E+L*G;a[6]=x*D+F*E+P*G;a[7]=B*D+N*E+Q*G;a[8]=r*I+J*n+K*p;a[9]=v*I+H*n+L*p;a[10]=x*I+F*n+P*p;a[11]=B*I+N*n+Q*p;return a},rotateXYZ:function(a,b,g,n){a=t.clone(a);return t.$rotateXYZ(a,b,g,n)},$rotateXYZ:function(a,b,g,n){var p=a[0],r=a[1],v=a[2],x=a[3],B=a[4],
C=a[5],D=a[6],E=a[7],G=a[8],I=a[9],J=a[10],H=a[11],F=k(b),N=k(g),K=k(n);b=s(b);var L=s(g),P=s(n);n=N*K;g=-F*P+b*L*K;var Q=b*P+F*L*K,R=N*P,U=F*K+b*L*P;K=-b*K+F*L*P;L=-L;b*=N;F*=N;a[0]=p*n+B*R+G*L;a[1]=r*n+C*R+I*L;a[2]=v*n+D*R+J*L;a[3]=x*n+E*R+H*L;a[4]=p*g+B*U+G*b;a[5]=r*g+C*U+I*b;a[6]=v*g+D*U+J*b;a[7]=x*g+E*U+H*b;a[8]=p*Q+B*K+G*F;a[9]=r*Q+C*K+I*F;a[10]=v*Q+D*K+J*F;a[11]=x*Q+E*K+H*F;return a},translate:function(a,b,g,n){a=t.clone(a);return t.$translate(a,b,g,n)},$translate:function(a,b,g,n){a[12]=a[0]*
b+a[4]*g+a[8]*n+a[12];a[13]=a[1]*b+a[5]*g+a[9]*n+a[13];a[14]=a[2]*b+a[6]*g+a[10]*n+a[14];a[15]=a[3]*b+a[7]*g+a[11]*n+a[15];return a},scale:function(a,b,g,n){a=t.clone(a);return t.$scale(a,b,g,n)},$scale:function(a,b,g,n){a[0]*=b;a[1]*=b;a[2]*=b;a[3]*=b;a[4]*=g;a[5]*=g;a[6]*=g;a[7]*=g;a[8]*=n;a[9]*=n;a[10]*=n;a[11]*=n;return a},invert:function(a){a=t.clone(a);return t.$invert(a)},$invert:function(a){var b=a[0],g=a[1],n=a[2],p=a[3],r=a[4],v=a[5],x=a[6],B=a[7],C=a[8],D=a[9],E=a[10],G=a[11],I=a[12],J=
a[13],H=a[14],F=a[15],N=b*v-g*r,K=b*x-n*r,L=b*B-p*r,P=g*x-n*v,Q=g*B-p*v,R=n*B-p*x,U=C*J-D*I,V=C*H-E*I,W=C*F-G*I,S=D*H-E*J,T=D*F-G*J,X=E*F-G*H,O=1/(N*X-K*T+L*S+P*W-Q*V+R*U);a[0]=(+v*X-x*T+B*S)*O;a[1]=(-g*X+n*T-p*S)*O;a[2]=(+J*R-H*Q+F*P)*O;a[3]=(-D*R+E*Q-G*P)*O;a[4]=(-r*X+x*W-B*V)*O;a[5]=(+b*X-n*W+p*V)*O;a[6]=(-I*R+H*L-F*K)*O;a[7]=(+C*R-E*L+G*K)*O;a[8]=(+r*T-v*W+B*U)*O;a[9]=(-b*T+g*W-p*U)*O;a[10]=(+I*Q-J*L+F*N)*O;a[11]=(-C*Q+D*L-G*N)*O;a[12]=(-r*S+v*V-x*U)*O;a[13]=(+b*S-g*V+n*U)*O;a[14]=(-I*P+J*K-H*
N)*O;a[15]=(+C*P-D*K+E*N)*O;return a},lookAt:function(a,b,g,n){g=l.sub(b,g);g.$unit();n=l.cross(n,g);n.$unit();var p=l.cross(g,n);p.$unit();return t.set(a,n[0],n[1],n[2],-n.dot(b),p[0],p[1],p[2],-p.dot(b),g[0],g[1],g[2],-g.dot(b),0,0,0,1)},frustum:function(a,b,g,n,p,r,v){var x=g-b,B=p-n,C=v-r;a[0]=r*2/x;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=r*2/B;a[6]=0;a[7]=0;a[8]=(g+b)/x;a[9]=(p+n)/B;a[10]=-(v+r)/C;a[11]=-1;a[12]=0;a[13]=0;a[14]=-(v*r*2)/C;a[15]=0;return a},perspective:function(a,b,g,n,p){b=n*j(b*f/
360);var r=-b;return t.frustum(a,r*g,b*g,r,b,n,p)},ortho:function(a,b,g,n,p,r,v){var x=g-b,B=p-n,C=v-r;a[0]=2/x;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=2/B;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=-2/C;a[11]=0;a[12]=-(b+g)/x;a[13]=-(p+n)/B;a[14]=-(v+r)/C;a[15]=1;return a},toFloat32Array:function(a){var b=a.typedContainer;if(!b)return a;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];b[9]=a[9];b[10]=a[10];b[11]=a[11];b[12]=a[12];b[13]=a[13];b[14]=a[14];b[15]=a[15];return b}};
q=t.prototype;for(w in m){t[w]=m[w];q[w]=function(a){return function(){var b=d.call(arguments);b.unshift(this);return t[a].apply(t,b)}}(w)}var A=function(a,b,g,n){c.call(this,4);this[0]=a||0;this[1]=b||0;this[2]=g||0;this[3]=n||0;this.typedContainer=new i(4)};A.create=function(){return new i(4)};m={setQuat:function(a,b){a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=b[3];return a},set:function(a,b,g,n,p){a[0]=b||0;a[1]=g||0;a[2]=n||0;a[3]=p||0;return a},clone:function(a){return a.$$family?new A(a[0],a[1],a[2],
a[3]):A.setQuat(new i(4),a)},neg:function(a){return new A(-a[0],-a[1],-a[2],-a[3])},$neg:function(a){a[0]=-a[0];a[1]=-a[1];a[2]=-a[2];a[3]=-a[3];return a},add:function(a,b){return new A(a[0]+b[0],a[1]+b[1],a[2]+b[2],a[3]+b[3])},$add:function(a,b){a[0]+=b[0];a[1]+=b[1];a[2]+=b[2];a[3]+=b[3];return a},sub:function(a,b){return new A(a[0]-b[0],a[1]-b[1],a[2]-b[2],a[3]-b[3])},$sub:function(a,b){a[0]-=b[0];a[1]-=b[1];a[2]-=b[2];a[3]-=b[3];return a},scale:function(a,b){return new A(a[0]*b,a[1]*b,a[2]*b,
a[3]*b)},$scale:function(a,b){a[0]*=b;a[1]*=b;a[2]*=b;a[3]*=b;return a},mulQuat:function(a,b){var g=a[0],n=a[1],p=a[2],r=a[3],v=b[0],x=b[1],B=b[2],C=b[3];return new A(r*v+g*C+n*B-p*x,r*x+n*C+p*v-g*B,r*B+p*C+g*x-n*v,r*C-g*v-n*x-p*B)},$mulQuat:function(a,b){var g=a[0],n=a[1],p=a[2],r=a[3],v=b[0],x=b[1],B=b[2],C=b[3];a[0]=r*v+g*C+n*B-p*x;a[1]=r*x+n*C+p*v-g*B;a[2]=r*B+p*C+g*x-n*v;a[3]=r*C-g*v-n*x-p*B;return a},divQuat:function(a,b){var g=a[0],n=a[1],p=a[2],r=a[3],v=b[0],x=b[1],B=b[2],C=b[3],D=1/(C*C+
v*v+x*x+B*B);return new A((g*C-r*v-n*B+p*x)*D,(g*B-r*x+n*C-p*v)*D,(n*v+p*C-r*B-g*x)*D,(r*C+g*v+n*x+p*B)*D)},$divQuat:function(a,b){var g=a[0],n=a[1],p=a[2],r=a[3],v=b[0],x=b[1],B=b[2],C=b[3],D=1/(C*C+v*v+x*x+B*B);a[0]=(g*C-r*v-n*B+p*x)*D;a[1]=(g*B-r*x+n*C-p*v)*D;a[2]=(n*v+p*C-r*B-g*x)*D;a[3]=(r*C+g*v+n*x+p*B)*D;return a},invert:function(a){var b=a[0],g=a[1],n=a[2];a=a[3];var p=1/(b*b+g*g+n*n+a*a);return new A(-b*p,-g*p,-n*p,a*p)},$invert:function(a){var b=a[0],g=a[1],n=a[2],p=a[3],r=1/(b*b+g*g+n*
n+p*p);a[0]=-b*r;a[1]=-g*r;a[2]=-n*r;a[3]=p*r;return a},norm:function(a){var b=a[0],g=a[1],n=a[2];a=a[3];return z(b*b+g*g+n*n+a*a)},normSq:function(a){var b=a[0],g=a[1],n=a[2];a=a[3];return b*b+g*g+n*n+a*a},unit:function(a){return A.scale(a,1/A.norm(a))},$unit:function(a){return A.$scale(a,1/A.norm(a))},conjugate:function(a){return new A(-a[0],-a[1],-a[2],a[3])},$conjugate:function(a){a[0]=-a[0];a[1]=-a[1];a[2]=-a[2];return a}};q=A.prototype={};for(w in m){A[w]=m[w];q[w]=function(a){return function(){var b=
d.call(arguments);b.unshift(this);return A[a].apply(A,b)}}(w)}l.fromQuat=function(a){return new l(a[0],a[1],a[2])};A.fromVec3=function(a,b){return new A(a[0],a[1],a[2],b||0)};A.fromMat4=function(a){var b,g,n;if(a[0]>a[5]&&a[0]>a[10]){b=0;g=1;n=2}else if(a[5]>a[0]&&a[5]>a[10]){b=1;g=2;n=0}else{b=2;g=0;n=1}var p=z(1+a[b*5]-a[g*5]-a[n*5]),r=new A;r[b]=0.5*p;r[g]=0.5*(a["n"+g+""+b]+a["n"+b+""+g])/p;r[n]=0.5*(a["n"+b+""+n]+a["n"+n+""+b])/p;r[3]=0.5*(a["n"+g+""+n]-a["n"+n+""+g])/p;return r};A.fromXRotation=
function(a){return new A(s(a/2),0,0,k(a/2))};A.fromYRotation=function(a){return new A(0,s(a/2),0,k(a/2))};A.fromZRotation=function(a){return new A(0,0,s(a/2),k(a/2))};A.fromAxisRotation=function(a,b){var g=a[0],n=a[1],p=a[2],r=1/z(g*g+n*n+p*p),v=s(b/2),x=k(b/2);return new A(v*g*r,v*n*r,v*p*r,x)};t.fromQuat=function(a){var b=a[3],g=a[0],n=a[1];a=a[2];return new t(b*b+g*g-n*n-a*a,2*g*n-2*b*a,2*g*a+2*b*n,0,2*g*n+2*b*a,b*b-g*g+n*n-a*a,2*n*a-2*b*g,0,2*g*a-2*b*n,2*n*a+2*b*g,b*b-g*g-n*n+a*a,0,0,0,0,1)};
PhiloGL.Vec3=l;PhiloGL.Mat4=t;PhiloGL.Quat=A})();(function(){function y(f){return f!==true?f:false}var z=function(f){f=f.getBoundingClientRect();return{x:f.left,y:f.top,bbox:f}},s={get:function(f,d){return f||(d||window).event},getWheel:function(f){return f.wheelDelta?f.wheelDelta/120:-(f.detail||0)/3},getKey:function(f){var d=f.which||f.keyCode,i;a:{i=j.Keys;for(var c in i)if(i[c]==d){i=c;break a}i=void 0}c=d-111;if(c>0&&c<13)i="f"+c;i=i||String.fromCharCode(d).toLowerCase();return{code:d,key:i,
shift:f.shiftKey,control:f.ctrlKey,alt:f.altKey,meta:f.metaKey}},isRightClick:function(f){return f.which==3||f.button==2},getPos:function(f,d){d=d||window;f=f||d.event;var i=d.document;i=i.documentElement||i.body;if(f.touches&&f.touches.length)f=f.touches[0];return{x:f.pageX||f.clientX+i.scrollLeft,y:f.pageY||f.clientY+i.scrollTop}},stop:function(f){f.stopPropagation&&f.stopPropagation();f.cancelBubble=true;if(f.preventDefault)f.preventDefault();else f.returnValue=false}},k=function(f,d){var i=f.canvas;
this.scene=f.scene;this.domElem=i;this.pos=z(i);this.opt=this.callbacks=d;this.size={width:i.width||i.offsetWidth,height:i.height||i.offsetHeight};this.attachEvents()};k.prototype={hovered:false,pressed:false,touched:false,touchMoved:false,moved:false,attachEvents:function(){var f=this.domElem,d=this;if(this.opt.disableContextMenu)f.oncontextmenu=function(){return false};["mouseup","mousedown","mousemove","mouseover","mouseout","touchstart","touchmove","touchend"].forEach(function(c){f.addEventListener(c,
function(h,l){d[c](d.eventInfo(c,h,l))},false)});["keydown","keyup"].forEach(function(c){document.addEventListener(c,function(h,l){d[c](d.eventInfo(c,h,l))},false)});var i="";i=!document.getBoxObjectFor&&window.mozInnerScreenX==null?"mousewheel":"DOMMouseScroll";f.addEventListener(i,function(c,h){d.mousewheel(d.eventInfo("mousewheel",c,h))},false)},eventInfo:function(f,d,i){var c=this.domElem,h=this.scene,l=this.opt,m=this.getSize(),q=l.relative,w=l.centerOrigin,t=l.cachePosition&&this.pos||z(c),
A=s.get(d,i),a=s.getPos(d,i);d={};i=a.x;c=a.y;if(q){i-=t.x;c-=t.y;if(w){i-=m.width/2;c-=m.height/2;c*=-1}}switch(f){case "mousewheel":d.wheel=s.getWheel(A);break;case "keydown":case "keyup":u.extend(d,s.getKey(A));break;case "mouseup":d.isRightClick=s.isRightClick(A)}var b;u.extend(d,{x:i,y:c,cache:false,stop:function(){s.stop(A)},getTarget:function(){if(b)return b;return b=!l.picking||h.pick(a.x-t.x,a.y-t.y,l.lazyPicking)||true}});d.event=A;return d},getSize:function(){if(this.cacheSize)return this.size;
var f=this.domElem;return{width:f.width||f.offsetWidth,height:f.height||f.offsetHeight}},mouseup:function(f){if(!this.moved)if(f.isRightClick)this.callbacks.onRightClick(f,this.hovered);else this.callbacks.onClick(f,y(this.pressed));if(this.pressed){if(this.moved)this.callbacks.onDragEnd(f,y(this.pressed));else this.callbacks.onDragCancel(f,y(this.pressed));this.pressed=this.moved=false}},mouseout:function(f){for(var d=f.relatedTarget,i=this.domElem;d&&d.parentNode;){if(i==d.parentNode)return;d=d.parentNode}if(this.hovered){this.callbacks.onMouseLeave(f,
this.hovered);this.hovered=false}if(this.pressed&&this.moved){this.callbacks.onDragEnd(f);this.pressed=this.moved=false}},mouseover:function(){},mousemove:function(f){if(this.pressed){this.moved=true;this.callbacks.onDragMove(f,y(this.pressed))}else{if(this.hovered){var d=y(f.getTarget());if(!d||d.hash!=this.hash){this.callbacks.onMouseLeave(f,this.hovered);if(this.hash=this.hovered=d){this.hash=d.hash;this.callbacks.onMouseEnter(f,this.hovered)}}else this.callbacks.onMouseMove(f,this.hovered)}else if(this.hash=
this.hovered=y(f.getTarget())){this.hash=this.hovered.hash;this.callbacks.onMouseEnter(f,this.hovered)}if(!this.opt.picking)this.callbacks.onMouseMove(f)}},mousewheel:function(f){this.callbacks.onMouseWheel(f)},mousedown:function(f){this.pressed=f.getTarget();this.callbacks.onDragStart(f,y(this.pressed))},touchstart:function(f){this.touched=f.getTarget();this.callbacks.onTouchStart(f,y(this.touched))},touchmove:function(f){if(this.touched){this.touchMoved=true;this.callbacks.onTouchMove(f,y(this.touched))}},
touchend:function(f){if(this.touched){if(this.touchMoved)this.callbacks.onTouchEnd(f,y(this.touched));else this.callbacks.onTouchCancel(f,y(this.touched));this.touched=this.touchMoved=false}},keydown:function(f){this.callbacks.onKeyDown(f)},keyup:function(f){this.callbacks.onKeyUp(f)}};var j={};j.create=function(f,d){d=u.extend({cachePosition:true,cacheSize:true,relative:true,centerOrigin:true,disableContextMenu:true,bind:false,picking:false,lazyPicking:false,onClick:u.empty,onRightClick:u.empty,
onDragStart:u.empty,onDragMove:u.empty,onDragEnd:u.empty,onDragCancel:u.empty,onTouchStart:u.empty,onTouchMove:u.empty,onTouchEnd:u.empty,onTouchCancel:u.empty,onMouseMove:u.empty,onMouseEnter:u.empty,onMouseLeave:u.empty,onMouseWheel:u.empty,onKeyDown:u.empty,onKeyUp:u.empty},d||{});var i=d.bind;if(i)for(var c in d)c.match(/^on[a-zA-Z0-9]+$/)&&function(h,l){d[h]=function(){return l.apply(i,Array.prototype.slice.call(arguments))}}(c,d[c]);new k(f,d);f.events=d};j.Keys={enter:13,up:38,down:40,left:37,
right:39,esc:27,space:32,backspace:8,tab:9,"delete":46};PhiloGL.Events=j})();(function(){function y(d,i){return u.merge(i||{},d.length==2?{vs:d[0],fs:d[1]}:d[0]||{})}var z=function(d,i,c){var h=d.createShader(c);if(h==null)throw"Error creating the shader with shader type: "+c;d.shaderSource(h,i);d.compileShader(h);if(!d.getShaderParameter(h,d.COMPILE_STATUS)){i=d.getShaderInfoLog(h);d.deleteShader(h);throw"Error while compiling the shader "+i;}return h},s=function(d){var i=d.lastIndexOf("/");return i==
"/"?"./":d.substr(0,i+1)},k=function(d,i,c,h,l){l=l||{};var m;if(m=i.match(/#include "(.*?)"/)){var q=PhiloGL.IO.XHR,w=s(d)+m[1];l[w]&&h("Recursive include");(new q({url:w,noCache:true,onError:function(t){h("Load included file `"+w+"` failed: Code "+t)},onSuccess:function(t){l[w]=true;return k(w,t,function(A){delete l[w];i=i.replace(/#include ".*?"/,A);i=i.replace(/\sHAS_EXTENSION\s*\(\s*([A-Za-z_\-0-9]+)\s*\)/g,function(a,b){return o.getExtension(b)?" 1 ":" 0 "});return k(w,i,c,h,l)},h,l)}})).send();
return null}else return c(i)},j=function(d,i,c){var h=o.getUniformLocation(d,i.name);d=i.type;var l=false,m=true,q,w;if(i.size>1&&c)switch(d){case o.FLOAT:q=o.uniform1fv;w=Float32Array;m=false;break;case o.INT:case o.BOOL:case o.SAMPLER_2D:case o.SAMPLER_CUBE:q=o.uniform1iv;w=Uint16Array;m=false}if(m)switch(d){case o.FLOAT:q=o.uniform1f;break;case o.FLOAT_VEC2:q=o.uniform2fv;w=c?Float32Array:new Float32Array(2);break;case o.FLOAT_VEC3:q=o.uniform3fv;w=c?Float32Array:new Float32Array(3);break;case o.FLOAT_VEC4:q=
o.uniform4fv;w=c?Float32Array:new Float32Array(4);break;case o.INT:case o.BOOL:case o.SAMPLER_2D:case o.SAMPLER_CUBE:q=o.uniform1i;break;case o.INT_VEC2:case o.BOOL_VEC2:q=o.uniform2iv;w=c?Uint16Array:new Uint16Array(2);break;case o.INT_VEC3:case o.BOOL_VEC3:q=o.uniform3iv;w=c?Uint16Array:new Uint16Array(3);break;case o.INT_VEC4:case o.BOOL_VEC4:q=o.uniform4iv;w=c?Uint16Array:new Uint16Array(4);break;case o.FLOAT_MAT2:l=true;q=o.uniformMatrix2fv;break;case o.FLOAT_MAT3:l=true;q=o.uniformMatrix3fv;
break;case o.FLOAT_MAT4:l=true;q=o.uniformMatrix4fv}if(q.bind)q=q.bind(o);else{var t=q;q=function(){t.apply(o,arguments)}}return c&&w?function(A){q(h,new w(A))}:l?function(A){q(h,false,A.toFloat32Array())}:w?function(A){w.set(A.toFloat32Array?A.toFloat32Array():A);q(h,w)}:function(A){q(h,A)};throw"Unknown type: "+d;},f=function(d,i){var c=o,h=c.createProgram();c.attachShader(h,z(c,d,c.VERTEX_SHADER));c.attachShader(h,z(c,i,c.FRAGMENT_SHADER));c.linkProgram(h);if(!c.getProgramParameter(h,c.LINK_STATUS))throw"Error linking the shader: "+
c.getProgramInfoLog(h);if(!h)return false;c={};for(var l={},m,q,w=o.getProgramParameter(h,o.ACTIVE_ATTRIBUTES),t=0;t<w;t++){m=o.getActiveAttrib(h,t);q=m.name;m=o.getAttribLocation(h,m.name);c[q]=m}w=o.getProgramParameter(h,o.ACTIVE_UNIFORMS);for(t=0;t<w;t++){m=o.getActiveUniform(h,t);q=m.name;q=q[q.length-1]=="]"?q.substr(0,q.length-3):q;l[q]=j(h,m,m.name!=q)}this.program=h;this.attributes=c;this.attributeEnabled={};this.uniforms=l};f.prototype={$$family:"program",setUniform:function(d,i){if(this.uniforms[d])this.uniforms[d](i);
return this},setUniforms:function(d){for(var i in d)this.setUniform(i,d[i]);return this}};["setBuffer","setBuffers","use"].forEach(function(d){f.prototype[d]=function(){var i=Array.prototype.slice.call(arguments);i.unshift(this);M[d].apply(M,i);return this}});["setFrameBuffer","setFrameBuffers","setRenderBuffer","setRenderBuffers","setTexture","setTextures"].forEach(function(d){f.prototype[d]=function(){M[d].apply(M,arguments);return this}});f.fromShaderIds=function(){var d=y(arguments),i=u(d.vs),
c=u(d.fs);return k(d.path,i.innerHTML,function(h){return k(d.path,c.innerHTML,function(l){d.onSuccess(new f(h,l),d)})})};f.fromShaderSources=function(){var d=y(arguments,{path:"./"});return k(d.path,d.vs,function(i){return k(d.path,d.fs,function(c){try{var h=new f(i,c);if(d.onSuccess)d.onSuccess(h,d);else return h}catch(l){if(d.onError)d.onError(l,d);else throw l;}})})};f.fromDefaultShaders=function(d){d=d||{};var i=d.fs||"Default",c=PhiloGL.Shaders;d.vs=c.Vertex[d.vs||"Default"];d.fs=c.Fragment[i];
return PhiloGL.Program.fromShaderSources(d)};f.fromShaderURIs=function(d){d=u.merge({path:"",vs:"",fs:"",noCache:false,onSuccess:u.empty,onError:u.empty},d||{});var i=d.path+d.vs,c=d.path+d.fs;(new PhiloGL.IO.XHR.Group({urls:[i,c],noCache:d.noCache,onError:function(h){d.onError(h)},onComplete:function(h){try{return k(i,h[0],function(m){return k(c,h[1],function(q){d.vs=m;d.fs=q;return f.fromShaderSources(d)},d.onError)},d.onError)}catch(l){d.onError(l,d)}}})).send()};PhiloGL.Program=f})();(function(){var y=
{},z=function(j){this.opt=j=u.merge({url:"http://philogljs.org/",method:"GET",async:true,noCache:false,sendAsBinary:false,responseType:false,onProgress:u.empty,onSuccess:u.empty,onError:u.empty,onAbort:u.empty,onComplete:u.empty},j||{});this.initXHR()};z.State={};["UNINITIALIZED","LOADING","LOADED","INTERACTIVE","COMPLETED"].forEach(function(j,f){z.State[j]=f});z.prototype={initXHR:function(){var j=this.req=new XMLHttpRequest,f=this;["Progress","Error","Abort","Load"].forEach(function(d){if(j.addEventListener)j.addEventListener(d.toLowerCase(),
function(i){f["handle"+d](i)},false);else j["on"+d.toLowerCase()]=function(i){f["handle"+d](i)}})},send:function(j){var f=this.req,d=this.opt,i=d.async;if(d.noCache)d.url+=(d.url.indexOf("?")>=0?"&":"?")+u.uid();f.open(d.method,d.url,i);if(d.responseType)f.responseType=d.responseType;if(i)f.onreadystatechange=function(){if(f.readyState==z.State.COMPLETED)if(f.status==200)d.onSuccess(f.responseType?f.response:f.responseText);else d.onError(f.status)};d.sendAsBinary?f.sendAsBinary(j||d.body||null):
f.send(j||d.body||null);if(!i)if(f.status==200)d.onSuccess(f.responseType?f.response:f.responseText);else d.onError(f.status)},setRequestHeader:function(j,f){this.req.setRequestHeader(j,f);return this},handleProgress:function(j){if(j.lengthComputable)this.opt.onProgress(j,Math.round(j.loaded/j.total*100));else this.opt.onProgress(j,-1)},handleError:function(j){this.opt.onError(j)},handleAbort:function(){this.opt.onAbort(e)},handleLoad:function(j){this.opt.onComplete(j)}};z.Group=function(j){function f(l){return function(m){--c;
j.onError(m,l);if(!c)j.onComplete(h)}}function d(l){return function(m){--c;h[l]=m;j.onSuccess(m,l);if(!c)j.onComplete(h)}}j=u.merge({urls:[],onError:u.empty,onSuccess:u.empty,onComplete:u.empty,method:"GET",async:true,noCache:false,sendAsBinary:false,responseType:false},j||{});var i=u.splat(j.urls),c=i.length,h=Array(c);this.reqs=i.map(function(l,m){return new z({url:l,method:j.method,async:j.async,noCache:j.noCache,sendAsBinary:j.sendAsBinary,responseType:j.responseType,body:j.body,onError:f(m),
onSuccess:d(m)})})};z.Group.prototype={send:function(){for(var j=0,f=this.reqs,d=f.length;j<d;++j)f[j].send()}};var s=function(j){j=u.merge({url:"http://philogljs.org/",data:{},noCache:false,onComplete:u.empty,callbackKey:"callback"},j||{});var f=s.counter++,d=[],i;for(i in j.data)d.push(i+"="+j.data[i]);d=d.join("&");if(j.noCache)d+=(d.indexOf("?")>=0?"&":"?")+u.uid();d=j.url+(j.url.indexOf("?")>-1?"&":"?")+j.callbackKey+"=PhiloGL.IO.JSONP.requests.request_"+f+(d.length>0?"&"+d:"");var c=document.createElement("script");
c.type="text/javascript";c.src=d;s.requests["request_"+f]=function(h){j.onComplete(h);c.parentNode&&c.parentNode.removeChild(c);c.clearAttributes&&c.clearAttributes()};document.getElementsByTagName("head")[0].appendChild(c)};s.counter=0;s.requests={};var k=function(j){j=u.merge({src:[],noCache:false,onProgress:u.empty,onComplete:u.empty},j||{});var f=0,d=j.src.length,i=function(){j.onProgress(Math.round(++f/d*100));if(f==d)j.onComplete(m)},c=function(){if(++f==d)j.onComplete(m)},h=j.noCache,l=u.uid(),
m=j.src.map(function(q,w){var t=new Image;t.index=w;t.onload=i;t.onerror=c;t.src=q+(h?(q.indexOf("?")>=0?"&":"?")+l:"");return t});return m};y.XHR=z;y.JSONP=s;y.Images=k;y.Textures=function(j){j=u.merge({src:[],noCache:false,onComplete:u.empty},j||{});k({src:j.src,noCache:j.noCache,onComplete:function(f){var d={};f.forEach(function(i,c){d[j.id&&j.id[c]||j.src&&j.src[c]]=u.merge({data:{value:i}},j)});M.setTextures(d);j.onComplete()}})};PhiloGL.IO=y})();(function(){var y=PhiloGL.Vec3,z=PhiloGL.Mat4,
s=function(k,j,f,d,i){i=i||{};var c=i.position,h=i.target,l=i.up;this.type=i.type?i.type:"perspective";this.fov=k;this.near=f;this.far=d;this.aspect=j;this.position=c&&new y(c.x,c.y,c.z)||new y;this.target=h&&new y(h.x,h.y,h.z)||new y;this.up=l&&new y(l.x,l.y,l.z)||new y(0,1,0);if(this.type=="perspective")this.projection=(new z).perspective(k,j,f,d);else{k=f*Math.tan(k*Math.PI/360);i=-k;this.projection=(new z).ortho(i*j,k*j,i,k,f,d)}this.view=new z};s.prototype={update:function(){if(this.type=="perspective")this.projection=
(new z).perspective(this.fov,this.aspect,this.near,this.far);else{var k=this.near*Math.tan(this.fov*Math.PI/360),j=-k,f=j*this.aspect,d=k*this.aspect;this.projection=(new z).ortho(f,d,j,k,this.near,this.far)}this.view.lookAt(this.position,this.target,this.up)}};PhiloGL.Camera=s})();(function(){function y(c,h){if(c&&c.length<h){for(var l=c[0],m=c[1],q=c[2],w=c[3],t=[l,m,q,w],A=h/c.length,a;--A;){a=A*4;t[a]=l;t[a+1]=m;t[a+2]=q;t[a+3]=w}return new Float32Array(t)}else return c}var z=PhiloGL.Vec3,s=PhiloGL.Mat4,
k=Math.cos,j=Math.sin,f=Math.PI,d=Array.prototype.slice,i={attributeMap:{position:"vertices",normal:"normals",pickingColor:"pickingColors",colors:"color"}};i.Model=function(c){c=c||{};this.id=c.id||u.uid();this.pickable=!!c.pickable;this.pick=c.pick||function(){return false};this.vertices=c.vertices;this.normals=c.normals;this.textures=c.textures&&u.splat(c.textures);this.colors=c.colors;this.indices=c.indices;this.shininess=c.shininess||0;this.reflection=c.reflection||0;this.refraction=c.refraction||
0;if(c.pickingColors)this.pickingColors=c.pickingColors;if(c.texCoords)this.texCoords=c.texCoords;this.uniforms=c.uniforms||{};this.attributes=c.attributes||{};this.render=c.render;this.drawType=c.drawType||"TRIANGLES";this.display="display"in c?c.display:true;this.onBeforeRender=c.onBeforeRender||u.empty;this.onAfterRender=c.onAfterRender||u.empty;if(c.program)this.program=c.program;this.position=new z;this.rotation=new z;this.scale=new z(1,1,1);this.matrix=new s;c.computeCentroids&&this.computeCentroids();
c.computeNormals&&this.computeNormals()};i.Model.prototype=Object.create(null,{hash:{get:function(){return this.id+" "+this.$pickingIndex}},vertices:{set:function(c){if(c){var h=c.length;if(c.BYTES_PER_ELEMENT)this.$vertices=c;else if(this.$verticesLength==h)this.$vertices.set(c);else this.$vertices=new Float32Array(c);this.$verticesLength=h}else{delete this.$vertices;delete this.$verticesLength}},get:function(){return this.$vertices}},normals:{set:function(c){if(c){var h=c.length;if(c.BYTES_PER_ELEMENT)this.$normals=
c;else if(this.$normalsLength==h)this.$normals.set(c);else this.$normals=new Float32Array(c);this.$normalsLength=h}else{delete this.$normals;delete this.$normalsLength}},get:function(){return this.$normals}},colors:{set:function(c){if(c){var h=c.length;if(c.BYTES_PER_ELEMENT)this.$colors=c;else if(this.$colorsLength==h)this.$colors.set(c);else this.$colors=new Float32Array(c);if(this.$vertices&&this.$verticesLength/3*4!=h)this.$colors=y(d.call(this.$colors),this.$verticesLength/3*4);this.$colorsLength=
this.$colors.length}else{delete this.$colors;delete this.$colorsLength}},get:function(){return this.$colors}},pickingColors:{set:function(c){if(c){var h=c.length;if(c.BYTES_PER_ELEMENT)this.$pickingColors=c;else if(this.$pickingColorsLength==h)this.$pickingColors.set(c);else this.$pickingColors=new Float32Array(c);if(this.$vertices&&this.$verticesLength/3*4!=h)this.$pickingColors=y(d.call(this.$pickingColors),this.$verticesLength/3*4);this.$pickingColorsLength=this.$pickingColors.length}else{delete this.$pickingColors;
delete this.$pickingColorsLength}},get:function(){return this.$pickingColors}},texCoords:{set:function(c){if(c)if(u.type(c)=="object"){var h={},l;for(l in c){var m=c[l];h[l]=m.BYTES_PER_ELEMENT?m:new Float32Array(m)}this.$texCoords=h}else{h=c.length;if(c.BYTES_PER_ELEMENT)this.$texCoords=c;else if(this.$texCoordsLength==h)this.$texCoords.set(c);else this.$texCoords=new Float32Array(c);this.$texCoordsLength=h}else{delete this.$texCoords;delete this.$texCoordsLength}},get:function(){return this.$texCoords}},
indices:{set:function(c){if(c){var h=c.length;if(c.BYTES_PER_ELEMENT)this.$indices=c;else if(this.$indicesLength==h)this.$indices.set(c);else this.$indices=new Uint16Array(c);this.$indicesLength=h}else{delete this.$indices;delete this.$indicesLength}},get:function(){return this.$indices}}});u.extend(i.Model.prototype,{$$family:"model",update:function(){var c=this.matrix,h=this.position,l=this.rotation,m=this.scale;c.id();c.$translate(h.x,h.y,h.z);c.$rotateXYZ(l.x,l.y,l.z);c.$scale(m.x,m.y,m.z)},computeCentroids:function(){var c=
this.vertices,h=[];this.faces.forEach(function(l){var m=[0,0,0],q=0;l.forEach(function(w){w=c[w];m[0]+=w[0];m[1]+=w[1];m[2]+=w[2];q++});m[0]/=q;m[1]/=q;m[2]/=q;h.push(m)});this.centroids=h},computeNormals:function(){var c=this.vertices,h=[];this.faces.forEach(function(l){var m=c[l[0]],q=c[l[1]];l=c[l[2]];m={x:m[0]-q[0],y:m[1]-q[1],z:m[2]-q[2]};z.$cross(m,{x:l[0]-q[0],y:l[1]-q[1],z:l[1]-q[2]});z.norm(m)>1.0E-6&&z.unit(m);h.push([m.x,m.y,m.z])});this.normals=h}});u.extend(i.Model.prototype,{setUniforms:function(c){c.setUniforms(this.uniforms)},
setAttributes:function(c){var h=this.attributes,l;for(l in h){var m=h[l],q=this.id+"-"+l;if(Object.keys(m).length){m.attribute=l;c.setBuffer(q,m);delete m.value}else c.setBuffer(q,true)}},setVertices:function(c){if(this.$vertices)this.dynamic?c.setBuffer("position-"+this.id,{attribute:"position",value:this.$vertices,size:3}):c.setBuffer("position-"+this.id)},setNormals:function(c){if(this.$normals)this.dynamic?c.setBuffer("normal-"+this.id,{attribute:"normal",value:this.$normals,size:3}):c.setBuffer("normal-"+
this.id)},setIndices:function(c){if(this.$indices)this.dynamic?c.setBuffer("indices-"+this.id,{bufferType:o.ELEMENT_ARRAY_BUFFER,drawType:o.STATIC_DRAW,value:this.$indices,size:1}):c.setBuffer("indices-"+this.id)},setPickingColors:function(c){if(this.$pickingColors)this.dynamic?c.setBuffer("pickingColor-"+this.id,{attribute:"pickingColor",value:this.$pickingColors,size:4}):c.setBuffer("pickingColor-"+this.id)},setColors:function(c){if(this.$colors)this.dynamic?c.setBuffer("color-"+this.id,{attribute:"color",
value:this.$colors,size:4}):c.setBuffer("color-"+this.id)},setTexCoords:function(c){if(this.$texCoords){var h=this.id,l,m,q,w;if(this.dynamic)if(u.type(this.$texCoords)=="object"){l=0;m=this.textures;for(q=m.length;l<q;l++){w=m[l];c.setBuffer("texCoord-"+l+"-"+h,{attribute:"texCoord"+(l+1),value:this.$texCoords[w],size:2})}}else c.setBuffer("texCoord-"+h,{attribute:"texCoord1",value:this.$texCoords,size:2});else if(u.type(this.$texCoords)=="object"){l=0;m=this.textures;for(q=m.length;l<q;l++)c.setBuffer("texCoord-"+
l+"-"+h)}else c.setBuffer("texCoord-"+h)}},setTextures:function(c){this.textures=this.textures?u.splat(this.textures):[];for(var h=0,l=this.textures,m=l.length,q=PhiloGL.Scene.MAX_TEXTURES;h<q;h++){if(h<m)if(M.textureMemo[l[h]].isCube){c.setUniform("hasTextureCube"+(h+1),true);c.setTexture(l[h],o["TEXTURE"+(h+5)])}else{c.setUniform("hasTexture"+(h+1),true);c.setTexture(l[h],o["TEXTURE"+h])}else{c.setUniform("hasTextureCube"+(h+1),false);c.setUniform("hasTexture"+(h+1),false)}c.setUniform("sampler"+
(h+1),h);c.setUniform("samplerCube"+(h+1),h+5)}},setState:function(c){this.setUniforms(c);this.setAttributes(c);this.setVertices(c);this.setColors(c);this.setPickingColors(c);this.setNormals(c);this.setTextures(c);this.setTexCoords(c);this.setIndices(c)},unsetState:function(c){c=c.attributes;o.bindBuffer(o.ARRAY_BUFFER,null);o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,null);for(var h in c)o.disableVertexAttribArray(c[h])}});i.Cube=function(c){i.Model.call(this,u.extend({vertices:[-1,-1,1,1,-1,1,1,1,1,-1,
1,1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,1,1,1,1,1,1,1,-1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1],texCoords:[0,0,1,0,1,1,0,1,1,0,1,1,0,1,0,0,0,1,0,0,1,0,1,1,1,1,0,1,0,0,1,0,1,0,1,1,0,1,0,0,0,0,1,0,1,1,0,1],normals:[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,
18,16,18,19,20,21,22,20,22,23]},c||{}))};i.Cube.prototype=Object.create(i.Model.prototype);i.Sphere=function(c){var h=c.nlat||10,l=c.nlong||10,m=c.radius||1,q=f-0,w=2*f-0,t=(h+1)*(l+1),A=new Float32Array(t*3),a=new Float32Array(t*3);t=new Float32Array(t*2);var b=new Uint16Array(h*l*6);if(typeof m=="number"){var g=m;m=function(){return g}}for(var n=0;n<=h;n++)for(var p=0;p<=l;p++){var r=p/l,v=n/h,x=w*r,B=q*v,C=j(x);x=k(x);var D=j(B),E=k(B);B=x*D;x=E;C*=D;D=m(B,x,C,r,v);E=p+n*(l+1);var G=E*3;E*=2;A[G+
0]=D*B;A[G+1]=D*x;A[G+2]=D*C;a[G+0]=B;a[G+1]=x;a[G+2]=C;t[E+0]=r;t[E+1]=v}m=h+1;for(p=0;p<h;p++)for(n=0;n<l;n++){E=(p*l+n)*6;b[E+0]=n*m+p;b[E+1]=n*m+p+1;b[E+2]=(n+1)*m+p;b[E+3]=(n+1)*m+p;b[E+4]=n*m+p+1;b[E+5]=(n+1)*m+p+1}i.Model.call(this,u.extend({vertices:A,indices:b,normals:a,texCoords:t},c||{}))};i.Sphere.prototype=Object.create(i.Model.prototype);i.IcoSphere=function(c){var h=c.iterations||0,l=[],m=[],q=Math.sqrt,w=Math.acos,t=Math.atan2,A=Math.PI,a=A*2;c.onAddVertex=c.onAddVertex||u.empty;var b=
(1+q(5))/2,g=q(1+b*b);l.push(-1/g,b/g,0,1/g,b/g,0,-1/g,-b/g,0,1/g,-b/g,0,0,-1/g,b/g,0,1/g,b/g,0,-1/g,-b/g,0,1/g,-b/g,b/g,0,-1/g,b/g,0,1/g,-b/g,0,-1/g,-b/g,0,1/g);m.push(0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1);var n=function(){var W={};return function(S,T){S*=3;T*=3;var X=(S<T?S:T)+"|"+(S>T?S:T);if(X in W)return W[X];var O=(l[S]+l[T])/2,Y=(l[S+1]+l[T+1])/2,Z=(l[S+2]+l[T+2])/2,$=q(O*O+Y*Y+Z*Z);O/=$;Y/=$;Z/=$;
l.push(O,Y,Z);return W[X]=l.length/3-1}}();for(b=0;b<h;b++){var p=[],r=0;for(g=m.length;r<g;r+=3){var v=n(m[r],m[r+1]),x=n(m[r+1],m[r+2]),B=n(m[r+2],m[r]);p.push(m[r],v,B,m[r+1],x,v,m[r+2],B,x,v,x,B)}m=p}g=m.length;h=new Float32Array(g*3);n=new Float32Array(g*2);for(b=0;b<g;b+=3){x=m[b];B=m[b+1];var C=m[b+2];p=x*3;r=B*3;v=C*3;x*=2;B*=2;C*=2;var D=l[p],E=l[p+1],G=l[p+2],I=w(G/q(D*D+E*E+G*G)),J=t(E,D);I/=A;J=1-J/a;var H=l[r],F=l[r+1],N=l[r+2],K=w(N/q(H*H+F*F+N*N)),L=t(F,H);K/=A;L=1-L/a;var P=l[v],Q=
l[v+1],R=l[v+2],U=w(R/q(P*P+Q*Q+R*R)),V=t(Q,P);U/=A;V=1-V/a;D=z.cross({x:P-H,y:Q-F,z:R-N},{x:D-H,y:E-F,z:G-N}).$unit();h[p]=h[r]=h[v]=D.x;h[p+1]=h[r+1]=h[v+1]=D.y;h[p+2]=h[r+2]=h[v+2]=D.z;n[x]=J;n[x+1]=I;n[B]=L;n[B+1]=K;n[C]=V;n[C+1]=U}i.Model.call(this,u.extend({vertices:l,indices:m,normals:h,texCoords:n},c||{}))};i.IcoSphere.prototype=Object.create(i.Model.prototype);i.TruncatedCone=function(c){var h=c.bottomRadius||0,l=c.topRadius||0,m=c.height||1,q=c.nradial||10,w=c.nvertical||10,t=!!c.topCap,
A=!!c.bottomCap,a=(t?2:0)+(A?2:0),b=(q+1)*(w+1+a),g=new Float32Array(b*3),n=new Float32Array(b*3);b=new Float32Array(b*2);var p=new Uint16Array(q*(w+a)*6),r=q+1,v=Math,x=v.atan2(h-l,m),B=v.sin,C=v.cos;v=v.PI;var D=C(x);x=B(x);A=w+(A?2:0);var E=0,G=0;for(t=t?-2:0;t<=A;t++){var I=t/w,J=m*I,H;if(t<0){J=0;I=1;H=h}else if(t>w){J=m;I=1;H=l}else H=h+(l-h)*(t/w);if(t==-2||t==w+2)I=H=0;J-=m/2;for(var F=0;F<r;F++){var N=B(F*v*2/q),K=C(F*v*2/q);g[E+0]=N*H;g[E+1]=J;g[E+2]=K*H;n[E+0]=t<0||t>w?0:N*D;n[E+1]=t<0?
-1:t>w?1:x;n[E+2]=t<0||t>w?0:K*D;b[G+0]=F/q;b[G+1]=I;G+=2;E+=3}}for(t=0;t<w+a;t++)for(F=0;F<q;F++){h=(t*q+F)*6;p[h+0]=r*(t+0)+0+F;p[h+1]=r*(t+0)+1+F;p[h+2]=r*(t+1)+1+F;p[h+3]=r*(t+0)+0+F;p[h+4]=r*(t+1)+1+F;p[h+5]=r*(t+1)+0+F}i.Model.call(this,u.extend({vertices:g,normals:n,texCoords:b,indices:p},c||{}))};i.TruncatedCone.prototype=Object.create(i.Model.prototype);i.Cone=function(c){c.topRadius=0;c.topCap=!!c.cap;c.bottomCap=!!c.cap;c.bottomRadius=c.radius||3;i.TruncatedCone.call(this,c)};i.Cone.prototype=
Object.create(i.TruncatedCone.prototype);i.Cylinder=function(c){c.bottomRadius=c.radius;c.topRadius=c.radius;i.TruncatedCone.call(this,c)};i.Cylinder.prototype=Object.create(i.TruncatedCone.prototype);i.Plane=function(c){var h=c.type,l=h.split(","),m=c[l[0]+"len"],q=c[l[1]+"len"],w=c["n"+l[0]]||1;l=c["n"+l[1]]||1;var t=c.offset,A=!!c.flipCull,a=(w+1)*(l+1),b=new Float32Array(a*3),g=new Float32Array(a*3);a=new Float32Array(a*2);var n=0,p=0;if(A)m=-m;for(var r=0;r<=l;r++)for(var v=0;v<=w;v++){var x=
v/w,B=r/l;a[n+0]=A?1-x:x;a[n+1]=B;n+=2;switch(h){case "x,y":b[p+0]=m*x-m*0.5;b[p+1]=q*B-q*0.5;b[p+2]=t;g[p+0]=0;g[p+1]=0;g[p+2]=A?1:-1;break;case "x,z":b[p+0]=m*x-m*0.5;b[p+1]=t;b[p+2]=q*B-q*0.5;g[p+0]=0;g[p+1]=A?1:-1;g[p+2]=0;break;case "y,z":b[p+0]=t;b[p+1]=m*x-m*0.5;b[p+2]=q*B-q*0.5;g[p+0]=A?1:-1;g[p+1]=0;g[p+2]=0}p+=3}h=w+1;m=[];for(r=0;r<l;r++)for(v=0;v<w;v++){q=(r*w+v)*6;m[q+0]=(r+0)*h+v;m[q+1]=(r+1)*h+v;m[q+2]=(r+0)*h+v+1;m[q+3]=(r+1)*h+v;m[q+4]=(r+1)*h+v+1;m[q+5]=(r+0)*h+v+1}i.Model.call(this,
u.extend({vertices:b,normals:g,texCoords:a,indices:m},c))};i.Plane.prototype=Object.create(i.Model.prototype);i.id=u.time();PhiloGL.O3D=i})();(function(){var y={Vertex:{},Fragment:{}},z=y.Fragment;y.Vertex.Default="#define LIGHT_MAX 40\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec4 color;\nattribute vec4 pickingColor;\nattribute vec2 texCoord1;\nuniform mat4 viewMatrix;\nuniform mat4 viewInverseMatrix;\nuniform mat4 projectionMatrix;\nuniform mat4 viewProjectionMatrix;\nuniform mat4 worldMatrix;\nuniform mat4 worldInverseMatrix;\nuniform mat4 worldInverseTransposeMatrix;\nuniform mat4 objectMatrix;\nuniform vec3 cameraPosition;\nuniform bool enableLights;\nuniform vec3 ambientColor;\nuniform vec3 directionalColor;\nuniform vec3 lightingDirection;\nuniform vec3 pointLocation[LIGHT_MAX];\nuniform vec3 pointColor[LIGHT_MAX];\nuniform int numberPoints;\nuniform bool useReflection;\nvarying vec3 vReflection;\nvarying vec4 vColor;\nvarying vec4 vPickingColor;\nvarying vec2 vTexCoord;\nvarying vec4 vNormal;\nvarying vec3 lightWeighting;\nvoid main(void) {\nvec4 mvPosition = worldMatrix * vec4(position, 1.0);\nvec4 transformedNormal = worldInverseTransposeMatrix * vec4(normal, 1.0);\nif(!enableLights) {\nlightWeighting = vec3(1.0, 1.0, 1.0);\n} else {\nvec3 plightDirection;\nvec3 pointWeight = vec3(0.0, 0.0, 0.0);\nfloat directionalLightWeighting = max(dot(transformedNormal.xyz, lightingDirection), 0.0);\nfor (int i = 0; i < LIGHT_MAX; i++) {\nif (i < numberPoints) {\nplightDirection = normalize((viewMatrix * vec4(pointLocation[i], 1.0)).xyz - mvPosition.xyz);\npointWeight += max(dot(transformedNormal.xyz, plightDirection), 0.0) * pointColor[i];\n} else {\nbreak;\n}\n}\nlightWeighting = ambientColor + (directionalColor * directionalLightWeighting) + pointWeight;\n}\nif (useReflection) {\nvReflection = (viewInverseMatrix[3] - (worldMatrix * vec4(position, 1.0))).xyz;\n} else {\nvReflection = vec3(1.0, 1.0, 1.0);\n}\nvColor = color;\nvPickingColor = pickingColor;\nvTexCoord = texCoord1;\nvNormal = transformedNormal;\ngl_Position = projectionMatrix * worldMatrix * vec4(position, 1.0);\n}";
z.Default="#ifdef GL_ES\nprecision highp float;\n#endif\nvarying vec4 vColor;\nvarying vec4 vPickingColor;\nvarying vec2 vTexCoord;\nvarying vec3 lightWeighting;\nvarying vec3 vReflection;\nvarying vec4 vNormal;\nuniform bool hasTexture1;\nuniform sampler2D sampler1;\nuniform bool hasTextureCube1;\nuniform samplerCube samplerCube1;\nuniform bool enablePicking;\nuniform bool hasPickingColors;\nuniform vec3 pickColor;\nuniform float reflection;\nuniform float refraction;\nuniform bool hasFog;\nuniform vec3 fogColor;\nuniform float fogNear;\nuniform float fogFar;\nvoid main(){\nif (!hasTexture1) {\ngl_FragColor = vec4(vColor.rgb * lightWeighting, vColor.a);\n} else {\ngl_FragColor = vec4(texture2D(sampler1, vec2(vTexCoord.s, vTexCoord.t)).rgb * lightWeighting, 1.0);\n}\nif (hasTextureCube1) {\nvec3 nReflection = normalize(vReflection);\nvec3 reflectionValue;\nif (refraction > 0.0) {\nreflectionValue = refract(nReflection, vNormal.xyz, refraction);\n} else {\nreflectionValue = -reflect(nReflection, vNormal.xyz);\n}\nvec4 cubeColor = textureCube(samplerCube1, vec3(-reflectionValue.x, -reflectionValue.y, reflectionValue.z));\ngl_FragColor = vec4(mix(gl_FragColor.xyz, cubeColor.xyz, reflection), 1.0);\n}\nif (enablePicking) {\nif (hasPickingColors) {\ngl_FragColor = vPickingColor;\n} else {\ngl_FragColor = vec4(pickColor, 1.0);\n}\n}\nif (hasFog) {\nfloat depth = gl_FragCoord.z / gl_FragCoord.w;\nfloat fogFactor = smoothstep(fogNear, fogFar, depth);\ngl_FragColor = mix(gl_FragColor, vec4(fogColor, gl_FragColor.w), fogFactor);\n}\n}";
PhiloGL.Shaders=y})();(function(){var y=PhiloGL.Vec3,z=!!(navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox/)),s=function(k,j,f){f=u.merge({lights:{enable:false,ambient:{r:0.2,g:0.2,b:0.2},directional:{direction:{x:1,y:1,z:1},color:{r:0,g:0,b:0}}},effects:{fog:false}},f||{});this.program=f.program?k[f.program]:k;this.camera=j;this.models=[];this.config=f};s.prototype={add:function(){for(var k=0,j=this.models,f=arguments.length;k<f;k++){var d=arguments[k];d.id=d.id||
u.uid();j.push(d);this.defineBuffers(d)}},remove:function(k){var j=this.models;k=j.indexOf(k);k>-1&&j.splice(k,1)},getProgram:function(k){var j=this.program;if(j.$$family!="program"&&k&&k.program){j=j[k.program];j.use()}return j},defineBuffers:function(k){var j=this.getProgram(k),f=k.dynamic;k.dynamic=true;k.setState(j);k.dynamic=f;k.unsetState(j)},beforeRender:function(k){this.setupLighting(k);this.setupEffects(k);var j=this.camera,f=j.position,d=j.view;j=j.projection;var i=d.mulMat4(j),c=i.invert();
k.setUniforms({cameraPosition:[f.x,f.y,f.z],projectionMatrix:j,viewMatrix:d,viewProjectionMatrix:i,viewInverseMatrix:d.invert(),viewProjectionInverseMatrix:c})},setupLighting:function(k){var j=this.config.lights,f=j.ambient,d=j.directional,i=d.color,c=d.direction,h=j.enable;j=j.points&&u.splat(j.points)||[];d=j.length;var l=[],m=[],q=[],w=[];c=(new y(c.x,c.y,c.z)).$unit().$scale(-1);k.setUniform("enableLights",h);if(h){k.setUniform("ambientColor",[f.r,f.g,f.b]);k.setUniform("directionalColor",[i.r,
i.g,i.b]);k.setUniform("lightingDirection",[c.x,c.y,c.z]);k.setUniform("numberPoints",d);for(f=0;f<d;f++){h=j[f];i=h.position;c=h.color||h.diffuse;h=h.specular;l.push(i.x,i.y,i.z);m.push(c.r,c.g,c.b);q.push(+!!h);h?w.push(h.r,h.g,h.b):w.push(0,0,0)}k.setUniforms({pointLocation:l,pointColor:m});k.setUniforms({enableSpecular:q,pointSpecularColor:w})}},setupEffects:function(k){var j=this.config.effects.fog,f=j.color||{r:0.5,g:0.5,b:0.5};j?k.setUniforms({hasFog:true,fogNear:j.near,fogFar:j.far,fogColor:[f.r,
f.g,f.b]}):k.setUniform("hasFog",false)},render:function(k){k=k||{};var j=this.camera,f=this.program,d=k.renderProgram,i=u.type(f);i=!d&&i=="object";k=u.extend({onBeforeRender:u.empty,onAfterRender:u.empty},k||{});!i&&this.beforeRender(d||f);for(var c=0,h=this.models,l=h.length;c<l;++c){var m=h[c];if(m.display){f=d||this.getProgram(m);i&&this.beforeRender(f);m.onBeforeRender(f,j);k.onBeforeRender(m,c);this.renderObject(m,f);k.onAfterRender(m,c);m.onAfterRender(f,j)}}},renderToTexture:function(k,j){j=
j||{};var f=M.textures[k+"-texture"],d=M.textureMemo[k+"-texture"];this.render(j);o.bindTexture(d.textureType,f);o.generateMipmap(d.textureType);o.bindTexture(d.textureType,null)},renderObject:function(k,j){var f=this.camera,d=k.matrix,i=f.view.mulMat4(d),c=i.invert(),h=c.transpose();k.setState(j);j.setUniforms({objectMatrix:d,worldMatrix:i,worldInverseMatrix:c,worldInverseTransposeMatrix:h});if(k.render)k.render(o,j,f);else k.$indicesLength?o.drawElements(k.drawType!==undefined?o.get(k.drawType):
o.TRIANGLES,k.$indicesLength,o.UNSIGNED_SHORT,0):o.drawArrays(k.drawType!==undefined?o.get(k.drawType):o.TRIANGLES,0,k.$verticesLength/3);k.unsetState(j)},setupPicking:function(){var k=PhiloGL.Program.fromDefaultShaders();M.setFrameBuffer("$picking",{width:5,height:1,bindToTexture:{parameters:[{name:"TEXTURE_ MAG_FILTER",value:"LINEAR"},{name:"TEXTURE_MIN_FILTER",value:"LINEAR",generateMipmap:z}]},bindToRenderBuffer:true});M.setFrameBuffer("$picking",false);this.pickingProgram=k},pick:function(k,
j){this.pickingProgram||this.setupPicking();var f={},d=[],i=M.usedProgram,c=this.pickingProgram,h=this.camera,l=h.target,m=h.aspect,q=this.config,w=q.lights.enable,t=q.effects.fog,A=o.canvas.width,a=o.canvas.height,b=this.unproject([k*2/A-1,1-j*2/a,1],h),g=new Uint8Array(4);this.camera.target=b;this.camera.update();q.lights.enable=false;q.effects.fog=false;M.setFrameBuffer("$picking",true);c.use();c.setUniform("enablePicking",true);o.disable(o.BLEND);o.viewport(0,0,5,1);o.clear(o.COLOR_BUFFER_BIT|
o.DEPTH_BUFFER_BIT);o.readPixels(0,0,1,1,o.RGBA,o.UNSIGNED_BYTE,g);this.renderPickingScene({background:g[0]+g[1]*256+g[2]*65536,o3dHash:f,o3dList:d,hash:[]});o.readPixels(2,0,1,1,o.RGBA,o.UNSIGNED_BYTE,g);b=[g[0],g[1],g[2]].join();b=f[b];var n;if(!b)for(var p=0,r=d.length;p<r;p++){b=d[p];n=b.pick(g);if(n!==false)b.$pickingIndex=n;else b=false}M.setFrameBuffer("$picking",false);M.setTexture("$picking-texture",false);c.setUniform("enablePicking",false);q.lights.enable=w;q.effects.fog=t;i&&i.use();o.viewport(0,
0,A,a);h.target=l;h.aspect=m;h.update();this.o3dHash=f;this.o3dList=d;this.pixel=g;this.capture=void 0;return b&&b.pickable&&b},unproject:function(k,j){return j.view.invert().mulMat4(j.projection.invert()).mulVec3(k)},renderPickingScene:function(k){if(this.config.renderPickingScene)this.config.renderPickingScene.call(this,k);else{var j=this.pickingProgram,f=k.o3dHash,d=k.o3dList,i=k.background,c=k.hash,h=0;this.renderToTexture("$picking",{renderProgram:j,onBeforeRender:function(l,m){if(m==i)h=1;var q=
m+h,w=!!l.pickingColors;j.setUniform("hasPickingColors",w);if(w)d.push(l);else{c[0]=q%256;c[1]=(q/256>>0)%256;c[2]=(q/65536>>0)%256;j.setUniform("pickColor",[c[0]/255,c[1]/255,c[2]/255]);f[c.join()]=l}}})}},resetPicking:u.empty};s.MAX_TEXTURES=10;s.MAX_POINT_LIGHTS=50;s.PICKING_RES=4;PhiloGL.Scene=s})();(function(){function y(z,s){for(var k=this.workers=[];s--;)k.push(new Worker(z))}y.prototype={map:function(z){var s=this.workers,k=this.configs=[],j=0;for(s=s.length;j<s;j++)k.push(z&&z(j));return this},
reduce:function(z){for(var s=z.reduceFn,k=this.workers,j=this.configs,f=k.length,d=z.initialValue,i=function(m){f--;d=d===undefined?m.data:s(d,m.data);if(f==0)z.onComplete(d)},c=0,h=f;c<h;c++){var l=k[c];l.onmessage=i;l.postMessage(j[c])}return this}};PhiloGL.WorkerGroup=y})();(function(){var y=function(d){this.opt=u.merge({delay:0,duration:1E3,transition:function(i){return i},onCompute:u.empty,onComplete:u.empty},d||{})},z=y.Queue=[];y.prototype={time:null,start:function(d){this.opt=u.merge(this.opt,
d||{});this.time=u.time();this.animating=true;z.push(this)},step:function(){if(this.animating){var d=u.time(),i=this.time,c=this.opt,h=c.delay,l=c.duration,m=0;if(d<i+h)c.onCompute.call(this,m);else if(d<i+h+l){m=c.transition((d-i-h)/l);c.onCompute.call(this,m)}else{this.animating=false;c.onCompute.call(this,1);c.onComplete.call(this)}}}};y.compute=function(d,i,c){return d+(i-d)*c};y.Transition={linear:function(d){return d}};var s=y.Transition;(function(){var d=function(h,l){l=u.splat(l);return u.extend(h,
{easeIn:function(m){return h(m,l)},easeOut:function(m){return 1-h(1-m,l)},easeInOut:function(m){return m<=0.5?h(2*m,l)/2:(2-h(2*(1-m),l))/2}})},i={Pow:function(h,l){return Math.pow(h,l[0]||6)},Expo:function(h){return Math.pow(2,8*(h-1))},Circ:function(h){return 1-Math.sin(Math.acos(h))},Sine:function(h){return 1-Math.sin((1-h)*Math.PI/2)},Back:function(h,l){l=l[0]||1.618;return Math.pow(h,2)*((l+1)*h-l)},Bounce:function(h){for(var l,m=0,q=1;;m+=q,q/=2)if(h>=(7-4*m)/11){l=q*q-Math.pow((11-6*m-11*h)/
4,2);break}return l},Elastic:function(h,l){return Math.pow(2,10*--h)*Math.cos(20*h*Math.PI*(l[0]||1)/3)}},c;for(c in i)s[c]=d(i[c]);["Quad","Cubic","Quart","Quint"].forEach(function(h,l){s[h]=d(function(m){return Math.pow(m,[l+2])})})})();var k=self||window,j=function(){var d=[];if(z.length){for(var i=0,c=z.length,h;i<c;i++){h=z[i];h.step();h.animating&&d.push(h)}y.Queue=z=d}};if(k){var f=false;["webkitAnimationTime","mozAnimationTime","animationTime","webkitAnimationStartTime","mozAnimationStartTime",
"animationStartTime"].forEach(function(d){if(d in k){y.animationTime=function(){return k[d]};f=true}});if(!f)y.animationTime=u.time;f=false;["webkitRequestAnimationFrame","mozRequestAnimationFrame","requestAnimationFrame"].forEach(function(d){if(d in k){y.requestAnimationFrame=function(i){k[d](function(){j();i()})};f=true}});if(!f)y.requestAnimationFrame=function(d){setTimeout(function(){j();d()},1E3/60)}}PhiloGL.Fx=y})();(function(){var y={},z=function(){};z.postProcess=function(){var s=new PhiloGL.O3D.Plane({type:"x,y",
xlen:1,ylen:1,offset:0}),k=new PhiloGL.Camera(45,1,0.1,500,{position:{x:0,y:0,z:1.205}}),j=new PhiloGL.Scene({},k);return function(f){var d=M.program.$$family?M.program:M.program[f.program],i=f.fromTexture?u.splat(f.fromTexture):[],c=f.toFrameBuffer,h=!!f.toScreen,l=f.width||M.canvas.width,m=f.height||M.canvas.height;k.aspect=f.aspectRatio?f.aspectRatio:Math.max(m/l,l/m);k.update();j.program=d;s.textures=i;s.program=d;j.models.length||j.add(s);if(c){c in M.frameBufferMemo||M.setFrameBuffer(c,{width:l,
height:m,bindToTexture:{parameters:[{name:"TEXTURE_MAG_FILTER",value:"LINEAR"},{name:"TEXTURE_MIN_FILTER",value:"LINEAR_MIPMAP_NEAREST",generateMipmap:false}]},bindToRenderBuffer:true});d.use();M.setFrameBuffer(c,true);o.viewport(0,0,l,m);o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT);d.setUniforms(f.uniforms||{});j.renderToTexture(c);M.setFrameBuffer(c,false)}if(h){d.use();o.viewport(0,0,l,m);o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT);d.setUniforms(f.uniforms||{});j.render()}return this}}();
y.Image=z;PhiloGL.Media=y})()})();
